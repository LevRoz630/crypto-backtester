> **Note: This document is generated by AI translation.**

# OMS Client SDK Documentation

This SDK wraps common APIs for interacting with the OMS service, implemented with `requests`, supports reading configuration from environment variables, and provides unified exception and error handling.

- Supported features:
  - Query asset balance, positions, asset change records
  - Set target position (long/short, by USDT value)
  - Batch set target positions
  - Query tradable contract list
  - Create strategy user (requires backend permission)
  - Context management and connection reuse

Language/environment: Python 3.12

Dependency: `requests`

## Installation & Configuration

- Install dependencies

```bash
pip install requests
```

- Environment variable configuration

```bash
export OMS_URL="https://your-oms-host"
export OMS_ACCESS_TOKEN="your-access-token"
```

- Or pass explicitly in code:

```python
from sdk.oms_client import OmsClient
client = OmsClient(base_url="https://your-oms-host", access_token="your-access-token")
```

## Quick Start

```python
from sdk.oms_client import OmsClient, ApiError, ConfigurationError

# Method 1: Use environment variables
client = OmsClient()

# Method 2: Pass parameters explicitly
# client = OmsClient(base_url="https://your-oms-host", access_token="your-access-token")

try:
    balances = client.get_balance()
    positions = client.get_position()

    # Set target position (example: long BTC-USDT perpetual contract, value 100 USDT)
    result = client.set_target_position(
        instrument_name="BTC-USDT",
        instrument_type="future",  # or "spot"
        target_value=100,           # Target position value (USDT)
        position_side="LONG"       # LONG or SHORT
    )
    print("Task ID:", result.get("id"))

finally:
    client.close()
```

- Or use context manager:

```python
from sdk.oms_client import OmsClient

with OmsClient() as client:
    print(client.get_balance())
```

## API Reference

The following APIs are provided by `sdk/oms_client.py`.

### Exception Types
- `OmsError`: SDK base exception
- `ConfigurationError`: Configuration error (missing `OMS_URL` or `OMS_ACCESS_TOKEN`)
- `AuthenticationError`: Authentication error (e.g. 401)
- `RateLimitError`: Rate limit triggered (429)
- `ApiError`: Other API call errors

### OmsClient

Constructor:

```python
OmsClient(base_url: Optional[str] = None,
          access_token: Optional[str] = None,
          timeout: int = 30)
```

- Parameter description
  - `base_url`: OMS service base URL (default reads from `OMS_URL`)
  - `access_token`: Bearer token (default reads from `OMS_ACCESS_TOKEN`)
  - `timeout`: Request timeout (seconds)

#### get_balance() -> List[Dict]
- Description: Get account asset list
- Return example:

```json
[
  {"asset": "USDT", "balance": "1234.56"},
  {"asset": "BTC",  "balance": "0.0123"}
]
```

- Throws `ApiError` on failure

#### get_position() -> List[Dict]
- Description: Get account position list
- Return example:

```json
[
  {
    "instrument_name": "BTC-USDT",
    "instrument_type": "future",
    "position_side": "LONG",
    "quantity": "0.001",
    "value": "100.00"
  }
]
```

- Throws `ApiError` on failure

#### get_asset_changes() -> List[Dict]
- Description: Get asset change history (recent entries)
- Return example:

```json
[
  {"asset": "USDT", "change": "-10.00", "balance": "1224.56", "create_time": "2024-09-01T10:00:00Z"}
]
```

- Throws `ApiError` on failure

#### get_symbols() -> List[str]
- Description: Get tradable contract list
- Return example:

```json
["BTC-USDT-PERP", "ETH-USDT-PERP", "SOL-USDT-PERP"]
```

- Throws `ApiError` on failure

#### set_target_position(instrument_name: str, instrument_type: str, target_value: float, position_side: str) -> Dict
- Description: Set target position
- Parameters:
  - `instrument_name`: e.g. `BTC-USDT`
  - `instrument_type`: `future` or `spot`
  - `target_value`: Target position value (USDT), positive for long, negative for short; when using this method, pass absolute value and specify direction via `position_side`
  - `position_side`: `LONG` or `SHORT`
- Returns: Task info dict (usually contains `id` etc.)
- Throws `ApiError` or `RateLimitError` on failure

Usage example:

```python
client.set_target_position(
    instrument_name="ETH-USDT",
    instrument_type="future",
    target_value=250.0,
    position_side="SHORT",
)
```

#### set_target_position_batch(items: List[Dict]) -> List[Dict]
- Description: Batch set target positions, submit multiple symbols at once to reduce API calls
- Parameters:
  - `items`: List, each element is a target position object, fields include:
    - `instrument_name`: e.g. `BTC-USDT-PERP`
    - `instrument_type`: `future` or `spot`
    - `target_value`: Target position value (USDT)
    - `position_side`: `LONG` or `SHORT`
- Returns: List of task info (each contains task id, symbol, direction, target value, etc.)
- Throws `ApiError` or `RateLimitError` on failure

Usage example:

```python
result = client.set_target_position_batch([
    {"instrument_name": "BTC-USDT-PERP", "instrument_type": "future", "target_value": 680, "position_side": "LONG"},
    {"instrument_name": "BTC-USDT-PERP", "instrument_type": "future", "target_value": 680, "position_side": "SHORT"}
])
print(result)
```

Return example (first request should succeed):

```json
{"status":"success","message":[{"id":59,"owner":3,"instrument_name":"BTC-USDT-PERP","instrument_type":"future","target_value":"680.00000000","position_side":"LONG","create_time":"2025-09-01 12:52:01","update_time":"2025-09-01 12:52:01"},{"id":60,"owner":3,"instrument_name":"BTC-USDT-PERP","instrument_type":"future","target_value":"680.00000000","position_side":"SHORT","create_time":"2025-09-01 12:52:01","update_time":"2025-09-01 12:52:01"}]}
```

#### create_strategy_user(name: str) -> Dict[str, str]
- Description: Create strategy user (requires proper backend permission)
- Parameter: `name` username
- Returns: Dict with username and token
- Throws `ApiError` or `AuthenticationError` on failure

#### create_client(base_url: Optional[str] = None, access_token: Optional[str] = None) -> OmsClient
- Description: Convenient factory function, equivalent to `OmsClient(...)`

#### Connection Management
- `close()`: Close underlying HTTP session
- Context manager: `with OmsClient() as client: ...`

## Error Handling & Retry Suggestions

- Basic error handling

```python
from sdk.oms_client import OmsClient, ApiError, AuthenticationError, RateLimitError, ConfigurationError

try:
    with OmsClient() as client:
        print(client.get_balance())
except ConfigurationError as e:
    print("Configuration error:", e)
except AuthenticationError as e:
    print("Authentication failed:", e)
except RateLimitError as e:
    print("Too many requests:", e)
except ApiError as e:
    print("API call failed:", e)
```

- Retry strategy:
  - For `RateLimitError`, use exponential backoff
  - For network errors (timeout, connection failure), retry a limited number of times
  - Handle idempotency carefully (avoid duplicate submissions for order/cancel operations)

## Best Practices
- Use context manager to ensure session is closed promptly
- Inject `OMS_URL` and `OMS_ACCESS_TOKEN` via environment variables, avoid hardcoding
- Log key requests and responses (sanitized) for troubleshooting
- Enable appropriate log level and alerts in production

## Version Info
- SDK file: `sdk/oms_client.py`
- Python: 3.8+ recommended

To extend/customize APIs, add methods in `OmsClient` and reuse `_make_request` for unified request and error handling.
